!function(n,r){"object"==typeof exports&&"undefined"!=typeof module?r(exports):"function"==typeof define&&define.amd?define(["exports"],r):r((n="undefined"!=typeof globalThis?globalThis:n||self).jotaiExperimental={})}(this,(function(n){"use strict";var r=0;function t(n){return n(this)}function e(n,r,t){return r(this,"function"==typeof t?t(n(this)):t)}function o(n,r){(null==r||r>n.length)&&(r=n.length);for(var t=0,e=new Array(r);t<r;t++)e[t]=n[t];return e}function i(n,r){var t="undefined"!=typeof Symbol&&n[Symbol.iterator]||n["@@iterator"];if(t)return(t=t.call(n)).next.bind(t);if(Array.isArray(n)||(t=function(n,r){if(n){if("string"==typeof n)return o(n,r);var t=Object.prototype.toString.call(n).slice(8,-1);return"Object"===t&&n.constructor&&(t=n.constructor.name),"Map"===t||"Set"===t?Array.from(n):"Arguments"===t||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t)?o(n,r):void 0}}(n))||r&&n&&"number"==typeof n.length){t&&(n=t);var e=0;return function(){return e>=n.length?{done:!0}:{done:!1,value:n[e++]}}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,u=function(n,r){return n.unstable_is?n.unstable_is(r):r===n},f=function(n){return"init"in n},v=function(n){return!!n.write},c=function(){return[new Set,new Set]},s=function(n,r){(n[0]||n[1]).add(r)},l=function(n,r){var t;if(r){if(n[0])return;t=n[1]}else{if(!n[0])throw new Error("[Bug] cannot sync flush twice");t=n[0]}for(var e=new Set;t.size;){var o=new Set(t);t.clear(),o.forEach((function(n){if("function"==typeof n)n();else{var r=n[0],t=n[1];!e.has(r)&&t.m&&(t.m.l.forEach((function(n){return n()})),e.add(r))}}))}return n[0]=void 0,e},d=Symbol(""),y="pending",m=new WeakMap,h=function(n){var r,t,e=null==(r=n.s)?void 0:r.v;return"object"==typeof(t=e)&&null!==t&&d in t&&e.status===y?e:null},p=function(n){if("e"in n.s)throw n.s.e;return n.s.v},w=function(n,r,t,e){void 0===t&&(t=function(){}),void 0===e&&(e=function(){});var o,i=h(n);if("function"==typeof(null==(o=r)?void 0:o.then))if(i)i!==r&&i[d](r,t);else{var a=function(n,r,t){if(!m.has(n)){var e,o=new Promise((function(i,a){var u=n,f=function(n){return function(r){u===n&&(o.status="fulfilled",o.value=r,i(r),t())}},v=function(n){return function(r){u===n&&(o.status="rejected",o.reason=r,a(r),t())}};n.then(f(n),v(n)),e=function(n,t){n&&(m.set(n,o),u=n,n.then(f(n),v(n))),r(),r=t}}));o.status=y,o[d]=e,m.set(n,o)}return m.get(n)}(r,t,e);n.s={v:a}}else i&&i[d](Promise.resolve(r),t),n.s={v:r}},b=function(){var n=new WeakMap,r=function(r){var t=n.get(r);return t||(t={d:new Map,t:new Set},n.set(r,t)),t},t=function n(t,e){var s=r(t);if(!e&&"s"in s){if(s.m)return s;if(Array.from(s.d).every((function(r){var t=r[0],e=r[1],o=n(t);return"v"in e&&"v"in o.s&&Object.is(e.v,o.s.v)})))return s}!function(n){for(var t,e=r(n),o=i(e.d.keys());!(t=o()).done;){var a=t.value;r(a).t.delete(n)}e.d.clear()}(t);var d,y,m=!0,h={get signal(){return d||(d=new AbortController),d.signal},get setSelf(){return!y&&v(t)&&(y=function(){if(!m){for(var n=arguments.length,r=new Array(n),e=0;e<n;e++)r[e]=arguments[e];return o.apply(void 0,[t].concat(r))}}),y}};try{var b=t.read((function(e){if(u(t,e)){var o=r(e);if(!o.s){if(!f(e))throw new Error("no atom init");w(o,e.init)}return p(o)}var i=n(e);return function(n,t,e,o){var i=r(n);if(i.d.set(t,e.s),e.t.add(n),!o&&i.m){var u=c();a(u,i),l(u)}}(t,e,i,m),p(i)}),h);return w(s,b,(function(){var n;return null==(n=d)?void 0:n.abort()}),(function(){if(s.m){var n=c();a(n,s),l(n)}})),s}catch(n){return s.s={e:n},s}finally{m=!1}},e=function n(e,o){for(var v=arguments.length,c=new Array(v>2?v-2:0),d=2;d<v;d++)c[d-2]=arguments[d];var y=o.write.apply(o,[function(n){return p(t(n))},function(v){for(var c,d=arguments.length,y=new Array(d>1?d-1:0),m=1;m<d;m++)y[m-1]=arguments[m];if(u(o,v)){if(!f(v))throw new Error("atom not writable");var p=r(v),b=p.s,g=y[0];w(p,g),a(e,p);var S=p.s;b&&"v"in b&&"v"in S&&Object.is(b.v,S.v)||(s(e,[v,p]),function(n,e){var o=[],u=new Set;!function n(t){if(!u.has(t)){u.add(t);for(var e,a=i(r(t).t);!(e=a()).done;){var f=e.value;t!==f&&n(f)}o.push(t)}}(e);for(var f=new Set([e]),v=o.length-1;v>=0;--v){for(var c,l=o[v],d=r(l),y=d.s,m=!1,p=i(d.d.keys());!(c=p()).done;){var w=c.value;if(w!==l&&f.has(w)){m=!0;break}}m&&(d.m||h(d))&&(t(l,!0),a(n,d),y&&"v"in y&&"v"in d.s&&Object.is(y.v,d.s.v)||(s(n,[l,d]),f.add(l)))}}(e,v))}else c=n.apply(void 0,[e,v].concat(y));return l(e,!0),c}].concat(c));return y},o=function(n){for(var r=c(),t=arguments.length,o=new Array(t>1?t-1:0),i=1;i<t;i++)o[i-1]=arguments[i];var a=e.apply(void 0,[r,n].concat(o));return l(r),a},a=function(n,r){if(r.m&&!h(r)){for(var t,e=i(r.d.keys());!(t=e()).done;){var o=t.value;r.m.d.has(o)||(y(n,o),r.m.d.add(o))}for(var a,u=i(r.m.d||[]);!(a=u()).done;){var f=a.value;r.d.has(f)||(m(n,f),r.m.d.delete(f))}}},y=function n(o,a){var u=r(a);if(!u.m){t(a);for(var f,c=i(u.d.keys());!(f=c()).done;){var l=f.value;n(o,l)}if(u.m={l:new Set,d:new Set(u.d.keys())},v(a)&&a.onMount){var d=u.m,y=a.onMount;s(o,(function(){var n=y((function(){for(var n=arguments.length,r=new Array(n),t=0;t<n;t++)r[t]=arguments[t];return e.apply(void 0,[o,a].concat(r))}));n&&(d.u=n)}))}}return u.m},m=function n(t,e){var o=r(e);if(o.m&&!o.m.l.size&&!Array.from(o.t).some((function(n){return r(n).m}))){var a=o.m.u;a&&s(t,a),delete o.m;for(var u,f=i(o.d.keys());!(u=f()).done;){n(t,u.value)}var v=h(o);v&&v[d](void 0,(function(){}))}};return{get:function(n){return p(t(n))},set:o,sub:function(n,r){var t=c(),e=y(t,n);l(t);var o=e.l;return o.add(r),function(){o.delete(r);var t=c();m(t,n),l(t)}}}};n.atom=function(n,o){var i="atom"+ ++r,a={toString:function(){return i}};return"function"==typeof n?a.read=n:(a.init=n,a.read=t,a.write=e),o&&(a.write=o),a},n.createStore=b,n.getDefaultStore=function(){return a||(a=b()),a}}));
